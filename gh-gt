#!/usr/bin/env bash
set -euo pipefail

# gh extension launcher for gh-gt
# Creates a local venv and runs the Python CLI module.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
REQ_FILE="$SCRIPT_DIR/requirements.txt"

PYTHON_BIN="python3"
if command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
fi

if [ ! -d "$VENV_DIR" ]; then
  echo "[gh-gt] Creating virtual environment..." >&2
  "$PYTHON_BIN" -m venv "$VENV_DIR"
fi

source "$VENV_DIR/bin/activate"

if [ -f "$REQ_FILE" ]; then
  # Best-effort install; allow running even if network is blocked.
  pip install --disable-pip-version-check -q -r "$REQ_FILE" || {
    echo "[gh-gt] Warning: failed to install dependencies. Proceeding with best-effort run." >&2
  }
fi

export PYTHONPATH="$SCRIPT_DIR/src${PYTHONPATH+:$PYTHONPATH}"

exec "$PYTHON_BIN" -m gt.cli "$@"

